<div class="container">
  <div class="header-section">
    <h2>Cocktails</h2>
    <div class="header-buttons">
      <button class="btn-primary" (click)="openModal()">Add New Cocktail</button>
      <button class="btn-secondary" (click)="openExportModal()">Export Cocktails</button>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-controls">
      <div class="filter-group">
        <label>Search by Name:</label>
        <input type="text" [(ngModel)]="nameFilter" placeholder="Filter by name...">
      </div>

      <div class="filter-group">
        <label>Filter by Spirit:</label>
        <select [(ngModel)]="spiritFilter">
          <option value="">All Spirits</option>
          @for (spirit of uniqueSpirits; track spirit) {
            <option [value]="spirit">{{ spirit }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label>Filter by Tag:</label>
        <select [(ngModel)]="tagFilter">
          <option value="">All Tags</option>
          @for (tag of allTags; track tag) {
            <option [value]="tag">{{ tag }}</option>
          }
        </select>
      </div>

      <div class="filter-group checkbox-filter">
        <label>
          <input type="checkbox" [(ngModel)]="showOnlyAvailable" (change)="toggleAvailableOnly()">
          Available Only
        </label>
      </div>

      <button class="btn-secondary clear-btn" (click)="clearFilters()">Clear Filters</button>
    </div>
  </div>

  <app-modal [isOpen]="isModalOpen" [title]="isEditMode ? 'Edit Cocktail' : 'Add New Cocktail'" (closed)="closeModal()">
    <form #cocktailForm="ngForm" (ngSubmit)="createCocktail()">
      <div class="form-group">
        <label>Cocktail Name:</label>
        <input type="text" [(ngModel)]="newCocktail.name" name="name" required #nameInput="ngModel">
        @if (nameInput.invalid && nameInput.touched) {
          <div class="error-message">
            Cocktail name is required
          </div>
        }
      </div>

      <div class="form-group">
        <label>Ingredients:</label>
        <div class="ingredient-inputs">
          <div class="ingredient-search-group">
            <input type="text"
              [(ngModel)]="ingredientSearchFilter"
              name="ingredientSearch"
              placeholder="Search ingredients..."
              class="ingredient-search">
              <select [(ngModel)]="newIngredientEntry.ingredientId" name="ingredientId">
                <option value="0">Select Ingredient</option>
                @for (ingredient of filteredIngredients; track ingredient.id) {
                  <option [value]="ingredient.id">
                    {{ ingredient.name }}
                  </option>
                }
              </select>
            </div>
            <input type="text" [(ngModel)]="newIngredientEntry.measure" name="measure" placeholder="Measure (e.g., 2 oz)">
            <button type="button" class="btn-secondary" (click)="addIngredientToCocktail()">Add</button>
            <button type="button" class="btn-primary" (click)="openIngredientModal()">+ New Ingredient</button>
          </div>
          <ul class="ingredient-list">
            @for (ing of newCocktail.ingredients; track ing; let i = $index) {
              <li>
                {{ getIngredientName(ing.ingredientId) }} - {{ ing.measure }}
                <button type="button" class="btn-small" (click)="removeIngredient(i)">Remove</button>
              </li>
            }
          </ul>
          @if (newCocktail.ingredients.length === 0 && cocktailForm.submitted) {
            <div class="error-message">
              At least one ingredient is required
            </div>
          }
        </div>

        <div class="form-group">
          <label>Steps:</label>
          <div class="step-inputs">
            <input type="text" [(ngModel)]="newStep" name="newStep" placeholder="Add a step">
            <button type="button" class="btn-secondary" (click)="addStep()">Add Step</button>
          </div>
          <ol class="steps-list">
            @for (step of newCocktail.steps; track step; let i = $index) {
              <li>
                {{ step }}
                <button type="button" class="btn-small" (click)="removeStep(i)">Remove</button>
              </li>
            }
          </ol>
        </div>

        <div class="form-group">
          <label>Notes:</label>
          <textarea [(ngModel)]="newCocktail.notes" name="notes" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Tags:</label>
          <div class="tag-inputs">
            <select [(ngModel)]="newTag" name="newTag" class="tag-select">
              <option value="">Select a tag or type new</option>
              @for (tag of allTags; track tag) {
                <option [value]="tag">{{ tag }}</option>
              }
            </select>
            <input type="text" [(ngModel)]="customTag" name="customTag" placeholder="Or type a new tag">
            <button type="button" class="btn-secondary" (click)="addTag()">Add Tag</button>
          </div>
          <div class="tag-list">
            @for (tag of newCocktail.tags; track tag; let i = $index) {
              <span class="tag-badge">
                {{ tag }}
                <button type="button" class="tag-remove" (click)="removeTag(i)">×</button>
              </span>
            }
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="cocktailForm.invalid || newCocktail.ingredients.length === 0">
            {{ isEditMode ? 'Update Cocktail' : 'Add Cocktail' }}
          </button>
        </div>
      </form>

      <!-- Nested Ingredient Creation Modal -->
      <app-modal [isOpen]="isIngredientModalOpen" [title]="'Add New Ingredient'" (closed)="closeIngredientModal()">
        <form #ingredientForm="ngForm" (ngSubmit)="createIngredientFromCocktail()">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" [(ngModel)]="newIngredientForCocktail.name" name="ingredientName" required #ingredientNameInput="ngModel">
            @if (ingredientNameInput.invalid && ingredientNameInput.touched) {
              <div class="error-message">
                Name is required
              </div>
            }
          </div>

          <div class="form-group">
            <label>Type:</label>
            <select [(ngModel)]="newIngredientForCocktail.type" name="ingredientType" required>
              @for (type of ingredientTypes; track type) {
                <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>ABV (%):</label>
            <input type="number" [(ngModel)]="newIngredientForCocktail.abv" name="ingredientAbv" min="0" max="100" required>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" [(ngModel)]="newIngredientForCocktail.inStock" name="ingredientInStock">
              In Stock
            </label>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeIngredientModal()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="ingredientForm.invalid">Add Ingredient</button>
          </div>
        </form>
      </app-modal>
    </app-modal>

    <div class="cocktails-list">
      <h3>{{ showOnlyAvailable ? 'Available Cocktails' : 'All Cocktails' }}</h3>
      <div class="cocktail-cards">
        @for (cocktail of displayedCocktails; track cocktail.id) {
          <div class="cocktail-card">
            <h4>{{ cocktail.name }}</h4>
            @if (cocktail.tags && cocktail.tags.length > 0) {
              <div class="card-section">
                <div class="tags-display">
                  @for (tag of cocktail.tags; track tag) {
                    <span class="tag-badge">{{ tag }}</span>
                  }
                </div>
              </div>
            }
            <div class="card-section">
              <strong>Ingredients:</strong>
              <ul>
                @for (ing of cocktail.ingredients; track ing.ingredientId) {
                  <li>
                    {{ getIngredientName(ing.ingredientId) }} - {{ ing.measure }}
                  </li>
                }
              </ul>
            </div>
            @if (cocktail.steps && cocktail.steps.length > 0) {
              <div class="card-section">
                <strong>Steps:</strong>
                <ol>
                  @for (step of cocktail.steps; track step) {
                    <li>{{ step }}</li>
                  }
                </ol>
              </div>
            }
            @if (cocktail.notes) {
              <div class="card-section">
                <strong>Notes:</strong>
                <p>{{ cocktail.notes }}</p>
              </div>
            }
            <div class="card-actions">
              <button class="btn-secondary" (click)="openEditModal(cocktail)">Edit</button>
              <button class="btn-danger" (click)="deleteCocktail(cocktail.id)">Delete</button>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Export Modal -->
    <app-modal [isOpen]="isExportModalOpen" [title]="'Export Cocktails'" (closed)="closeExportModal()">
      <form (ngSubmit)="proceedWithExport()">
        <div class="form-group">
          <label>Export Type:</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="exportType" [(ngModel)]="exportType" [value]="ExportType.MENU">
              Menu (Name + Ingredients only)
            </label>
            <label>
              <input type="radio" name="exportType" [(ngModel)]="exportType" [value]="ExportType.CHEATSHEET">
              CheatSheet (Full Recipe with Steps)
            </label>
          </div>
        </div>

        @if (exportType === ExportType.MENU) {
          <div class="form-group">
            <label>Group By:</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="groupBy" [(ngModel)]="exportGroupBy" value="spirit">
                Spirit
              </label>
              <label>
                <input type="radio" name="groupBy" [(ngModel)]="exportGroupBy" value="tags">
                Tags
              </label>
            </div>
          </div>
        }

        <div class="form-group">
          <label>Format:</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="exportFormat" [(ngModel)]="exportFormat" [value]="ExportFormat.HTML">
              HTML
            </label>
            <label>
              <input type="radio" name="exportFormat" [(ngModel)]="exportFormat" [value]="ExportFormat.MARKDOWN">
              Markdown (.md)
            </label>
            <label>
              <input type="radio" name="exportFormat" [(ngModel)]="exportFormat" [value]="ExportFormat.PDF">
              PDF (Print to PDF)
            </label>
          </div>
        </div>

        <div class="export-info">
          <p>Exporting {{ displayedCocktails.length }} cocktail(s) based on current filters.</p>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeExportModal()">Cancel</button>
          <button type="submit" class="btn-primary">Next</button>
        </div>
      </form>
    </app-modal>

    <!-- Tag Selection Modal -->
    <app-modal [isOpen]="isTagSelectionModalOpen" [title]="'Select Tags for Grouping'" (closed)="closeTagSelectionModal()">
      <div class="tag-selection-content">
        <p class="info-text">Select which tags to use for grouping and arrange them in order:</p>

        <div class="tag-selection-section">
          <h4>Available Tags:</h4>
          <div class="available-tags">
            @for (tag of availableTagsForExport; track tag) {
              <label class="tag-checkbox">
                <input
                  type="checkbox"
                  [checked]="isTagSelected(tag)"
                  (change)="toggleTagSelection(tag)">
                  {{ tag }}
                </label>
              }
            </div>
          </div>

          @if (selectedTagsForExport.length > 0) {
            <div class="tag-selection-section">
              <h4>Selected Tags (in order):</h4>
              <div class="selected-tags-list">
                @for (tag of selectedTagsForExport; track tag; let i = $index) {
                  <div class="selected-tag-item">
                    <span class="tag-name">{{ i + 1 }}. {{ tag }}</span>
                    <div class="tag-controls">
                      <button
                        type="button"
                        class="btn-small"
                        (click)="moveTagUp(i)"
                        [disabled]="i === 0">
                        ↑
                      </button>
                      <button
                        type="button"
                        class="btn-small"
                        (click)="moveTagDown(i)"
                        [disabled]="i === selectedTagsForExport.length - 1">
                        ↓
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeTagSelectionModal()">Back</button>
            <button
              type="button"
              class="btn-primary"
              (click)="confirmTagSelection()"
              [disabled]="selectedTagsForExport.length === 0">
              Export
            </button>
          </div>
        </div>
      </app-modal>
    </div>
