<div class="container">
  <div class="header-section">
    <h2>Cocktails</h2>
    <button class="btn-primary" (click)="openModal()">Add New Cocktail</button>
  </div>
  
  <div class="filter-section">
    <div class="filter-controls">
      <div class="filter-group">
        <label>Search by Name:</label>
        <input type="text" [(ngModel)]="nameFilter" placeholder="Filter by name...">
      </div>
      
      <div class="filter-group">
        <label>Filter by Spirit:</label>
        <select [(ngModel)]="spiritFilter">
          <option value="">All Spirits</option>
          <option *ngFor="let spirit of uniqueSpirits" [value]="spirit">{{ spirit }}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Filter by Tag:</label>
        <select [(ngModel)]="tagFilter">
          <option value="">All Tags</option>
          <option *ngFor="let tag of allTags" [value]="tag">{{ tag }}</option>
        </select>
      </div>
      
      <div class="filter-group checkbox-filter">
        <label>
          <input type="checkbox" [(ngModel)]="showOnlyAvailable" (change)="toggleAvailableOnly()">
          Available Only
        </label>
      </div>
      
      <button class="btn-secondary clear-btn" (click)="clearFilters()">Clear Filters</button>
    </div>
  </div>

  <app-modal [isOpen]="isModalOpen" [title]="isEditMode ? 'Edit Cocktail' : 'Add New Cocktail'" (closed)="closeModal()">
    <form #cocktailForm="ngForm" (ngSubmit)="createCocktail()">
      <div class="form-group">
        <label>Cocktail Name:</label>
        <input type="text" [(ngModel)]="newCocktail.name" name="name" required #nameInput="ngModel">
        <div *ngIf="nameInput.invalid && nameInput.touched" class="error-message">
          Cocktail name is required
        </div>
      </div>

      <div class="form-group">
        <label>Ingredients:</label>
        <div class="ingredient-inputs">
          <div class="ingredient-search-group">
            <input type="text" 
                   [(ngModel)]="ingredientSearchFilter" 
                   name="ingredientSearch" 
                   placeholder="Search ingredients..."
                   class="ingredient-search">
            <select [(ngModel)]="newIngredientEntry.ingredientId" name="ingredientId">
              <option value="0">Select Ingredient</option>
              <option *ngFor="let ingredient of filteredIngredients" [value]="ingredient.id">
                {{ ingredient.name }}
              </option>
            </select>
          </div>
          <input type="text" [(ngModel)]="newIngredientEntry.measure" name="measure" placeholder="Measure (e.g., 2 oz)">
          <button type="button" class="btn-secondary" (click)="addIngredientToCocktail()">Add</button>
          <button type="button" class="btn-primary" (click)="openIngredientModal()">+ New Ingredient</button>
        </div>
        <ul class="ingredient-list">
          <li *ngFor="let ing of newCocktail.ingredients; let i = index">
            {{ getIngredientName(ing.ingredientId) }} - {{ ing.measure }}
            <button type="button" class="btn-small" (click)="removeIngredient(i)">Remove</button>
          </li>
        </ul>
        <div *ngIf="newCocktail.ingredients.length === 0 && cocktailForm.submitted" class="error-message">
          At least one ingredient is required
        </div>
      </div>

      <div class="form-group">
        <label>Steps:</label>
        <div class="step-inputs">
          <input type="text" [(ngModel)]="newStep" name="newStep" placeholder="Add a step">
          <button type="button" class="btn-secondary" (click)="addStep()">Add Step</button>
        </div>
        <ol class="steps-list">
          <li *ngFor="let step of newCocktail.steps; let i = index">
            {{ step }}
            <button type="button" class="btn-small" (click)="removeStep(i)">Remove</button>
          </li>
        </ol>
      </div>

      <div class="form-group">
        <label>Notes:</label>
        <textarea [(ngModel)]="newCocktail.notes" name="notes" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label>Tags:</label>
        <div class="tag-inputs">
          <select [(ngModel)]="newTag" name="newTag" class="tag-select">
            <option value="">Select a tag or type new</option>
            <option *ngFor="let tag of allTags" [value]="tag">{{ tag }}</option>
          </select>
          <input type="text" [(ngModel)]="customTag" name="customTag" placeholder="Or type a new tag">
          <button type="button" class="btn-secondary" (click)="addTag()">Add Tag</button>
        </div>
        <div class="tag-list">
          <span *ngFor="let tag of newCocktail.tags; let i = index" class="tag-badge">
            {{ tag }}
            <button type="button" class="tag-remove" (click)="removeTag(i)">Ã—</button>
          </span>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="cocktailForm.invalid || newCocktail.ingredients.length === 0">
          {{ isEditMode ? 'Update Cocktail' : 'Add Cocktail' }}
        </button>
      </div>
    </form>
    
    <!-- Nested Ingredient Creation Modal -->
    <app-modal [isOpen]="isIngredientModalOpen" [title]="'Add New Ingredient'" (closed)="closeIngredientModal()">
      <form #ingredientForm="ngForm" (ngSubmit)="createIngredientFromCocktail()">
        <div class="form-group">
          <label>Name:</label>
          <input type="text" [(ngModel)]="newIngredientForCocktail.name" name="ingredientName" required #ingredientNameInput="ngModel">
          <div *ngIf="ingredientNameInput.invalid && ingredientNameInput.touched" class="error-message">
            Name is required
          </div>
        </div>
        
        <div class="form-group">
          <label>Type:</label>
          <select [(ngModel)]="newIngredientForCocktail.type" name="ingredientType" required>
            <option *ngFor="let type of ingredientTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ABV (%):</label>
          <input type="number" [(ngModel)]="newIngredientForCocktail.abv" name="ingredientAbv" min="0" max="100" required>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" [(ngModel)]="newIngredientForCocktail.inStock" name="ingredientInStock">
            In Stock
          </label>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeIngredientModal()">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="ingredientForm.invalid">Add Ingredient</button>
        </div>
      </form>
    </app-modal>
  </app-modal>

  <div class="cocktails-list">
    <h3>{{ showOnlyAvailable ? 'Available Cocktails' : 'All Cocktails' }}</h3>
    <div class="cocktail-cards">
      <div *ngFor="let cocktail of displayedCocktails" class="cocktail-card">
        <h4>{{ cocktail.name }}</h4>
        
        <div class="card-section" *ngIf="cocktail.tags && cocktail.tags.length > 0">
          <div class="tags-display">
            <span *ngFor="let tag of cocktail.tags" class="tag-badge">{{ tag }}</span>
          </div>
        </div>
        
        <div class="card-section">
          <strong>Ingredients:</strong>
          <ul>
            <li *ngFor="let ing of cocktail.ingredients">
              {{ getIngredientName(ing.ingredientId) }} - {{ ing.measure }}
            </li>
          </ul>
        </div>

        <div class="card-section" *ngIf="cocktail.steps && cocktail.steps.length > 0">
          <strong>Steps:</strong>
          <ol>
            <li *ngFor="let step of cocktail.steps">{{ step }}</li>
          </ol>
        </div>

        <div class="card-section" *ngIf="cocktail.notes">
          <strong>Notes:</strong>
          <p>{{ cocktail.notes }}</p>
        </div>

        <div class="card-actions">
          <button class="btn-secondary" (click)="openEditModal(cocktail)">Edit</button>
          <button class="btn-danger" (click)="deleteCocktail(cocktail.id)">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>
